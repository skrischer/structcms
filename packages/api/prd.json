{
  "project_meta": {
    "name": "@structcms/api",
    "version": "0.1.0",
    "description": "Storage, domain API, and delivery API for StructCMS"
  },
  "context": {
    "dependencies": {
      "runtime": ["@supabase/supabase-js", "sanitize-html"],
      "peer": ["next >=15.0.0"],
      "dev": ["vitest", "typescript", "@types/sanitize-html"]
    },
    "environment_variables": {
      "SUPABASE_URL": "https://your-project.supabase.co",
      "SUPABASE_SECRET_KEY": "Service role key for server-side operations",
      "SUPABASE_STORAGE_BUCKET": "Storage bucket for media uploads (default: media)"
    },
    "supabase_setup": {
      "storage_bucket": "media (public access enabled)",
      "tables": ["pages", "navigation", "media"],
      "rls_policies": "To be defined - MVP may use service role key"
    },
    "package_exports": [
      "createStorageAdapter",
      "createMediaAdapter",
      "createSupabaseAdapters",
      "createNextPagesRoute",
      "createNextPageBySlugRoute",
      "createNextPageByIdRoute",
      "createNextMediaRoute",
      "createNextMediaByIdRoute",
      "createNextNavigationRoute",
      "createNextNavigationByIdRoute",
      "SupabaseStorageAdapter",
      "SupabaseMediaAdapter",
      "StorageError",
      "StorageValidationError",
      "MediaError",
      "MediaValidationError",
      "handleCreatePage",
      "handleUpdatePage",
      "handleDeletePage",
      "handleCreateNavigation",
      "handleUpdateNavigation",
      "handleDeleteNavigation",
      "handleListPages",
      "handleGetPageBySlug",
      "handleGetNavigation",
      "handleUploadMedia",
      "handleGetMedia",
      "handleListMedia",
      "handleDeleteMedia",
      "resolveMediaReferences",
      "handleExportPage",
      "handleExportAllPages",
      "handleExportNavigations",
      "handleExportSite",
      "generateSlug",
      "ensureUniqueSlug",
      "ALLOWED_MIME_TYPES",
      "Page (type)",
      "PageSection (type)",
      "PageFilter (type)",
      "CreatePageInput (type)",
      "UpdatePageInput (type)",
      "Navigation (type)",
      "NavigationItem (type)",
      "CreateNavigationInput (type)",
      "UpdateNavigationInput (type)",
      "StorageAdapter (type)",
      "SupabaseStorageAdapterConfig (type)",
      "MediaFile (type)",
      "MediaAdapter (type)",
      "UploadMediaInput (type)",
      "MediaFilter (type)",
      "AllowedMimeType (type)",
      "SupabaseMediaAdapterConfig (type)",
      "PageResponse (type)",
      "NavigationResponse (type)",
      "ListPagesOptions (type)",
      "PageExportResponse (type)",
      "AllPagesExportResponse (type)",
      "NavigationExportResponse (type)",
      "AllNavigationsExportResponse (type)",
      "SiteExportResponse (type)",
      "MediaExportEntry (type)"
    ],
    "api_endpoints": {
      "delivery_public": [
        "GET /api/cms/pages",
        "GET /api/cms/pages/:slug",
        "GET /api/cms/navigation/:name",
        "GET /api/cms/media"
      ],
      "preset_quickstart": [
        "GET /api/cms/pages",
        "POST /api/cms/pages",
        "GET /api/cms/pages/[slug]",
        "PUT /api/cms/pages/[id]",
        "DELETE /api/cms/pages/[id]",
        "GET /api/cms/media",
        "POST /api/cms/media",
        "DELETE /api/cms/media/[id]",
        "GET /api/cms/navigation",
        "POST /api/cms/navigation",
        "DELETE /api/cms/navigation/[id]"
      ],
      "admin_protected": [
        "POST /api/cms/pages",
        "PUT /api/cms/pages/:id",
        "DELETE /api/cms/pages/:id",
        "POST /api/cms/navigation",
        "PUT /api/cms/navigation/:id",
        "DELETE /api/cms/navigation/:id",
        "POST /api/cms/media",
        "GET /api/cms/media/:id",
        "DELETE /api/cms/media/:id"
      ],
      "export": [
        "GET /api/cms/export",
        "GET /api/cms/export/pages",
        "GET /api/cms/export/pages/:slug",
        "GET /api/cms/export/navigation"
      ]
    },
    "file_structure": {
      "src/": "Source files",
      "src/index.ts": "Package entry point with all public exports",
      "src/storage/": "Storage adapter interfaces, implementations, and handlers",
      "src/storage/types.ts": "StorageAdapter interface, Page, Navigation types",
      "src/storage/supabase-adapter.ts": "SupabaseStorageAdapter implementation",
      "src/storage/handlers.ts": "Page and Navigation CRUD handler functions",
      "src/delivery/": "Delivery API handler functions",
      "src/delivery/types.ts": "PageResponse, NavigationResponse types",
      "src/delivery/handlers.ts": "Public delivery handlers (list, get by slug)",
      "src/media/": "Media adapter interfaces, implementations, and handlers",
      "src/media/types.ts": "MediaAdapter interface, MediaFile type",
      "src/media/supabase-adapter.ts": "SupabaseMediaAdapter implementation",
      "src/media/handlers.ts": "Media upload, get, list, delete handlers",
      "src/media/resolve.ts": "Media reference resolution (UUID to URL)",
      "src/export/": "Export handler functions",
      "src/export/types.ts": "Export response types",
      "src/export/handlers.ts": "Page, navigation, and site export handlers",
      "src/next/": "Next.js App Router preset factories",
      "src/next/*.ts": "Factory helpers returning route handlers (GET/POST/PUT/DELETE)",
      "src/supabase/": "Supabase bootstrap and adapter factory",
      "src/supabase/factory.ts": "createSupabaseAdapters() factory",
      "src/utils/slug.ts": "Slug generation and uniqueness utilities",
      "src/utils/sanitize.ts": "HTML sanitization for XSS protection",
      "src/types/database.types.ts": "Generated Supabase types"
    },
    "integration_in_host": {
      "next_js_route_handlers": "Host project can use preset factories in app/api/cms/* route files to reduce boilerplate to one export line",
      "quickstart_example": "import { createSupabaseAdapters } from '@structcms/api/supabase'; import { createNextPagesRoute } from '@structcms/api/next'; const adapters = createSupabaseAdapters({ url: process.env.SUPABASE_URL, key: process.env.SUPABASE_SECRET_KEY }); export const { GET, POST } = createNextPagesRoute(adapters);",
      "advanced_example": "import { createStorageAdapter, handleListPages } from '@structcms/api'; const storage = createStorageAdapter({ client });"
    },
    "notes": [
      "All interfaces are Supabase-agnostic for future portability",
      "Delivery endpoints are public (no auth)",
      "Admin endpoints require Supabase Auth (Phase 2: proper RLS)",
      "Media accepts only: jpg, jpeg, png, gif, webp, svg",
      "Export includes resolved media URLs for backup/migration",
      "Presets are opt-in convenience APIs; core handlers remain first-class",
      "Supabase adapter factory supports env defaults and explicit values"
    ]
  },
  "backlog": [
    {
      "group": "Storage",
      "feature": "Storage Interface Definition",
      "description": "Define StorageAdapter interface with CRUD methods for pages, navigation, providing abstraction over Supabase for future portability",
      "acceptance_criteria": [
        "StorageAdapter interface defined with getPage, savePage, deletePage, listPages",
        "PageFilter type defined for list filtering",
        "Interface is Supabase-agnostic (no Supabase types in interface)",
        "Unit test: interface types compile correctly"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Supabase Storage Adapter",
      "description": "Implement SupabaseStorageAdapter that implements StorageAdapter interface using Supabase client",
      "acceptance_criteria": [
        "SupabaseStorageAdapter implements StorageAdapter",
        "Uses supabase-js client for database operations",
        "Handles connection errors gracefully",
        "Integration test: CRUD operations work against Supabase"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Database Schema: Pages Table",
      "description": "Create pages table with id (uuid), slug (unique), page_type, sections (jsonb), timestamps",
      "acceptance_criteria": [
        "SQL migration creates pages table",
        "slug has unique constraint",
        "sections stored as JSONB",
        "created_at and updated_at timestamps with defaults",
        "Migration documented in README"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Database Schema: Navigation Table",
      "description": "Create navigation table with id (uuid), name, items (jsonb), timestamps",
      "acceptance_criteria": [
        "SQL migration creates navigation table",
        "name has unique constraint",
        "items stored as JSONB (array of nav items)",
        "Migration documented in README"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Page CRUD Operations",
      "description": "Implement Create, Read, Update, Delete operations for pages via StorageAdapter",
      "acceptance_criteria": [
        "createPage() creates new page with generated ID",
        "getPage(slug) retrieves page by slug",
        "updatePage() updates existing page",
        "deletePage(id) removes page",
        "listPages(filter?) returns filtered page list",
        "Integration test: all CRUD operations"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Navigation CRUD Operations",
      "description": "Implement Create, Read, Update, Delete operations for navigation",
      "acceptance_criteria": [
        "createNavigation() creates new navigation",
        "getNavigation(name) retrieves by name",
        "updateNavigation() updates existing",
        "deleteNavigation(id) removes navigation",
        "Integration test: all CRUD operations"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Slug Generation and Uniqueness",
      "description": "Auto-generate URL-safe slugs from page title, ensure uniqueness by appending suffix if needed",
      "acceptance_criteria": [
        "generateSlug(title) creates URL-safe slug",
        "Handles special characters, spaces, umlauts",
        "Appends -1, -2, etc. if slug exists",
        "Unit test: slug generation and uniqueness"
      ],
      "passes": true
    },
    {
      "group": "Delivery",
      "feature": "Delivery Endpoints",
      "description": "Create REST endpoints for frontend consumption: GET /api/cms/pages, GET /api/cms/pages/:slug, GET /api/cms/navigation/:name",
      "acceptance_criteria": [
        "GET /api/cms/pages returns all pages (public)",
        "GET /api/cms/pages/:slug returns single page (public)",
        "GET /api/cms/navigation/:name returns navigation (public)",
        "Responses match PageResponse/NavigationResponse types",
        "404 for non-existent resources",
        "Integration test: all endpoints"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Storage Integration Tests",
      "description": "Comprehensive integration tests for all storage operations against Supabase",
      "acceptance_criteria": [
        "Test database setup/teardown",
        "All CRUD operations tested",
        "Error cases tested (not found, duplicate slug)",
        "Tests run in CI environment"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Media Interface Definition",
      "description": "Define MediaAdapter interface with upload, list, delete methods for media files",
      "acceptance_criteria": [
        "MediaAdapter interface with upload, getMedia, listMedia, deleteMedia",
        "MediaFile type with id, filename, url, mimeType, size",
        "Interface is Supabase-agnostic",
        "Unit test: interface types compile"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Supabase Media Adapter",
      "description": "Implement SupabaseMediaAdapter using Supabase Storage for file storage",
      "acceptance_criteria": [
        "SupabaseMediaAdapter implements MediaAdapter",
        "Files uploaded to Supabase Storage bucket",
        "Public URLs generated for uploaded files",
        "Integration test: upload and retrieve file"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Database Schema: Media Table",
      "description": "Create media table with id, filename, storage_path, mime_type, size, timestamps",
      "acceptance_criteria": [
        "SQL migration creates media table",
        "storage_path references Supabase Storage path",
        "Migration documented in README"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Media Upload Endpoint",
      "description": "POST /api/cms/media endpoint accepting file upload, storing in Supabase Storage, recording in database",
      "acceptance_criteria": [
        "Accepts multipart/form-data file upload",
        "Validates file type (jpg, jpeg, png, gif, webp, svg)",
        "Stores file in Supabase Storage",
        "Creates media record in database",
        "Returns MediaFile with public URL",
        "Integration test: upload flow"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Media List Endpoint",
      "description": "GET /api/cms/media endpoint returning paginated list of media files",
      "acceptance_criteria": [
        "Returns array of MediaFile objects",
        "Supports pagination (limit, offset)",
        "Ordered by created_at descending",
        "Integration test: list with pagination"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Media Delete Endpoint",
      "description": "DELETE /api/cms/media/:id endpoint removing file from storage and database",
      "acceptance_criteria": [
        "Deletes file from Supabase Storage",
        "Removes record from database",
        "Returns 404 if not found",
        "Integration test: delete flow"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Media Reference Resolution",
      "description": "Image field type in content resolves to full media URL in delivery responses",
      "acceptance_criteria": [
        "image fields store media ID or path",
        "Delivery API resolves to public URL",
        "Handles missing media gracefully (null or placeholder)",
        "Unit test: resolution logic"
      ],
      "passes": true
    },
    {
      "group": "Media",
      "feature": "Media Integration Tests",
      "description": "Comprehensive integration tests for media upload, list, delete against Supabase Storage",
      "acceptance_criteria": [
        "Test file upload with valid image",
        "Test rejection of invalid file types",
        "Test list and pagination",
        "Test delete removes file and record"
      ],
      "passes": true
    },
    {
      "group": "Export",
      "feature": "Single Page Export",
      "description": "GET /api/cms/export/pages/:slug returns complete page JSON including resolved media URLs",
      "acceptance_criteria": [
        "Returns full page data as JSON",
        "Media references resolved to URLs",
        "Content-Disposition header for download",
        "Integration test: export single page"
      ],
      "passes": true
    },
    {
      "group": "Export",
      "feature": "All Pages Export",
      "description": "GET /api/cms/export/pages returns all pages as JSON array",
      "acceptance_criteria": [
        "Returns array of all pages",
        "Media references resolved to URLs",
        "Content-Disposition header for download",
        "Integration test: export all pages"
      ],
      "passes": true
    },
    {
      "group": "Export",
      "feature": "Navigation Export",
      "description": "GET /api/cms/export/navigation returns all navigation structures as JSON",
      "acceptance_criteria": [
        "Returns array of all navigations",
        "Content-Disposition header for download",
        "Integration test: export navigation"
      ],
      "passes": true
    },
    {
      "group": "Export",
      "feature": "Full Site Export",
      "description": "GET /api/cms/export returns complete site content (pages, navigation, media metadata) as JSON",
      "acceptance_criteria": [
        "Returns { pages, navigation, media } object",
        "Media includes URLs for external download",
        "Suitable for backup or migration",
        "Integration test: full export"
      ],
      "passes": true
    },
    {
      "group": "Export",
      "feature": "Backup Documentation",
      "description": "Document backup strategy using export endpoints in README",
      "acceptance_criteria": [
        "README section on backup strategy",
        "Example curl commands for export",
        "Guidance on restoring from export",
        "Media backup considerations documented"
      ],
      "passes": true
    },
    {
      "group": "Refactor",
      "feature": "Export Cosmetic Fixes",
      "description": "Fix inline import in export/types.ts, extract toNavigationExport helper, move contentDisposition into handlers.ts",
      "acceptance_criteria": [
        "No inline imports in export/types.ts",
        "contentDisposition moved out of types.ts into handlers.ts",
        "Shared toNavigationExport() helper eliminates duplication",
        "All existing tests still pass"
      ],
      "passes": true
    },
    {
      "group": "Refactor",
      "feature": "Remove Dead Code",
      "description": "Delete unused storage/supabase-client.ts",
      "acceptance_criteria": [
        "supabase-client.ts removed",
        "No remaining imports of supabase-client",
        "All existing tests still pass"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Storage Page Handlers",
      "description": "Add handler functions for page CRUD (create, update, delete) with validation and slug handling",
      "acceptance_criteria": [
        "handleCreatePage with slug generation and validation",
        "handleUpdatePage with validation",
        "handleDeletePage",
        "Unit tests with mock adapter",
        "Exported from storage/index.ts and package entry point"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Storage Navigation Handlers",
      "description": "Add handler functions for navigation CRUD (create, update, delete) with validation",
      "acceptance_criteria": [
        "handleCreateNavigation with validation",
        "handleUpdateNavigation with validation",
        "handleDeleteNavigation",
        "Unit tests with mock adapter",
        "Exported from storage/index.ts and package entry point"
      ],
      "passes": true
    },
    {
      "group": "Refactor",
      "feature": "Remove Slug Logic from Adapter",
      "description": "Remove duplicated slug generation and uniqueness logic from SupabaseStorageAdapter.createPage(). The adapter should store the slug as-is. Slug handling is the handler's responsibility.",
      "acceptance_criteria": [
        "SupabaseStorageAdapter.createPage() no longer generates or deduplicates slugs",
        "getAllSlugs() private method removed if no longer needed",
        "generateSlug/ensureUniqueSlug imports removed from supabase-adapter.ts if unused",
        "All existing tests still pass",
        "Adapter integration tests updated if needed"
      ],
      "passes": true
    },
    {
      "group": "Refactor",
      "feature": "Consistent Comment Style",
      "description": "Align comment conventions across all domains to match the media/ reference pattern: no trailing periods on JSDoc, JSDoc on interface methods, no section separators, JSDoc on private adapter methods",
      "acceptance_criteria": [
        "storage/handlers.ts JSDoc without trailing periods",
        "StorageAdapter interface methods have JSDoc comments",
        "Section separators removed from supabase-adapter.ts",
        "getAllSlugs (if still present) has JSDoc",
        "All existing tests still pass"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Richtext HTML Sanitization on Write",
      "description": "Sanitize all string values in page sections when pages are created or updated via handleCreatePage/handleUpdatePage. Recursively walks sections[].data and sanitizes every string value. This ensures the database only ever contains safe HTML, protecting all consumers (frontend, export, API) from XSS. No dependency on @structcms/core registry â€” keeps the API package decoupled.",
      "acceptance_criteria": [
        "handleCreatePage sanitizes all string values in sections[].data before storage",
        "handleUpdatePage sanitizes all string values in sections[].data before storage",
        "Sanitization strips script tags, event handlers, and dangerous attributes",
        "Allowed tags: p, h1-h6, ul, ol, li, a (href only), strong, em, br, blockquote, code, pre, img (src, alt only)",
        "Sanitization recursively walks nested objects and arrays in section data",
        "Plain text strings pass through unchanged (no HTML tags to strip)",
        "Unit test: script tags stripped from string values",
        "Unit test: safe HTML preserved unchanged",
        "Unit test: nested objects and arrays are recursively sanitized"
      ],
      "passes": true
    },
    {
      "group": "Storage",
      "feature": "Sanitization Integration Tests",
      "description": "Integration tests verifying that richtext sanitization works end-to-end through the storage handlers",
      "acceptance_criteria": [
        "Integration test: create page with malicious HTML in section data, verify stored content is sanitized",
        "Integration test: update page with malicious HTML in section data, verify stored content is sanitized",
        "Integration test: delivery endpoint returns sanitized HTML",
        "Integration test: nested string values in array/object section data are sanitized"
      ],
      "passes": true
    },
    {
      "group": "DX",
      "feature": "Supabase Adapter Factory",
      "description": "Implement createSupabaseAdapters() to centralize Supabase client bootstrap and return storage/media adapters for quickstart integrations",
      "acceptance_criteria": [
        "createSupabaseAdapters({ url, key, storage? }) returns { storageAdapter, mediaAdapter }",
        "Supports explicit config values and env defaults (SUPABASE_URL, SUPABASE_SECRET_KEY, SUPABASE_STORAGE_BUCKET)",
        "Factory does not change existing adapter interfaces or handler signatures",
        "Unit test: explicit config path works",
        "Unit test: env default path works"
      ],
      "passes": true
    },
    {
      "group": "DX",
      "feature": "Next.js Preset Factories (App Router)",
      "description": "Add opt-in preset factories under @structcms/api/next that expose Next route handlers while keeping core handlers framework-agnostic",
      "acceptance_criteria": [
        "Exports include createNextPagesRoute, createNextPageBySlugRoute, createNextPageByIdRoute",
        "Exports include createNextMediaRoute, createNextMediaByIdRoute",
        "Exports include createNextNavigationRoute, createNextNavigationByIdRoute",
        "Preset route handlers map to existing API contracts without changing core handler signatures",
        "Unit tests cover success and error responses for each preset factory"
      ],
      "passes": true
    },
    {
      "group": "DX",
      "feature": "Quickstart Example Alignment (API Integration)",
      "description": "Refactor examples/test-app API routes to use createSupabaseAdapters() and @structcms/api/next presets as canonical quickstart integration",
      "acceptance_criteria": [
        "test-app routes use preset factory exports instead of manual route boilerplate",
        "test-app adapter bootstrap uses createSupabaseAdapters()",
        "E2E tests still pass with the quickstart path",
        "README examples match the test-app integration"
      ],
      "passes": false
    },
    {
      "group": "Documentation",
      "feature": "Quickstart Documentation (API)",
      "description": "Document the P1 quickstart path for API setup using Supabase adapter factory and Next preset factories",
      "acceptance_criteria": [
        "packages/api/README contains a quickstart section with minimal setup",
        "Documents required env vars and optional overrides",
        "Shows one-line route file examples for pages/media/navigation",
        "Explains that presets are opt-in and core handlers remain available"
      ],
      "passes": true
    }
  ]
}
